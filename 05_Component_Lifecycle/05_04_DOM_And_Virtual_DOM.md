# Что такое DOM и Virtual DOM

> [!NOTE]
> Данная глава является дополнительной и не является обязательной для прохождения курса. Она предназначена для тех, кто хочет углубить свои знания в работе React и понять, как работает Virtual DOM.

## DOM

### Что такое DOM?

**DOM (Document Object Model)** — это объектная модель документа, которая представляет HTML-страницу в виде структуры объектов. Проще говоря, DOM — это дерево, которое браузер строит из HTML-кода страницы [^1]. Эта структура имеет вид дерева узлов, где каждый элемент HTML является узлом. Корневым узлом обычно является элемент `<html>`, внутри него ветви – `<head>`, `<body>` и так далее, вплоть до самых мелких “листьев” – текстов и атрибутов.

Рассмотрим пример HTML-кода:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Document</title>
  </head>
  <body>
    <h1>Hello, World!</h1>
  </body>
</html>
```

Этот код преобразуется в следующую структуру DOM:

```
html
├── head
│   └── title
│       └── Document
└── body
    └── h1
        └── Hello, World!
```

### Как браузер работает с DOM?

Когда браузер загружает HTML-файл, он парсит его и строит на основе полученных данных DOM-дерево в памяти. Используя это дерево и стили CSS, браузер отрисовывает веб-страницу на экране. DOM предоставляет интерфейс для программирования, который позволяет JavaScript обращаться к элементам страницы и изменять их содержимое, структуру или стили. Когда скрипт изменяет DOM (например, добавляет новый элемент или изменяет текст), браузер обновляет отображение страницы, отражая эти изменения.

**Пример 1.** _Изменение содержимого элемента с помощью JavaScript:_

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Document</title>
  </head>
  <body>
    <h1 id="heading">Hello, World!</h1>
    <script>
      document.getElementById('heading').textContent = 'Goodbye, World!';
    </script>
  </body>
</html>
```

В данном примере скрипт изменяет текст заголовка `<h1>` с **"Hello, World!"** на **"Goodbye, World!"**. Изменяется DOM, и браузер обновляет страницу, показывая новый текст.

Но почему мы говорим про DOM? Дело в том, что React построен на таком же принципе. React также использует виртуальное представление DOM, называемое Virtual DOM.

## Что такое Virtual DOM и зачем он нужен?

### Проблема с DOM

Браузер представляют страницу в виде дерева элементов – DOM (Document Object Model, «объектная модель документа»). JavaScript может менять это дерево: добавлять/удалять узлы, менять текст и атрибуты. Когда вы изменяете DOM, браузер должен обновить страницу.

**Что происходит при изменениях**: Любое изменение DOM запускает тяжелые процессы отрисовки в браузере. Например, при изменении элемента браузер:

1. _Пересчитывает стили_ для элемента и, возможно, связанных с ним узлов (Recalculate Style) – заново вычисляет CSS-правила, которые должны примениться​
2. _Выполняет компоновку (Layout, reflow)_ – перерасчитывает положение и размеры элементов на странице с учётом изменений.
3. _Перерисовывает_ изменённые части на экране (Paint/Repaint)​

**Все эти операции требуют ресурсов**. Если менять DOM очень часто (например, в цикле или при каждом действии пользователя), браузер будет многократно повторять пересчёт стилей, компоновку и перерисовку. В результате страница начинает тормозить из-за постоянной переработки изменений.

**Почему частые изменения замедляют страницу**: Прямая работа с DOM не была рассчитана на большие динамические интерфейсы. После каждого изменения нужно заново отрендерить изменённый элемент и всех его потомков (вложенные элементы) в дереве​. **Такой повторный рендеринг – очень медленный процесс**​. Чем больше элементов на странице, тем больше работы приходится делать браузеру при каждом обновлении. Многие фреймворки (или скрипты на чистом JS) нередко обновляют больше, чем требуется. _Например_, если из списка в 10 элементов изменился только первый элемент, наивное обновление может полностью перестроить весь список – то есть выполнить в 10 раз больше работы, хотя изменился лишь один элемент​. Подобные лишние перерисовки и пересчёты стилей сильно бьют по производительности [^2].

### Как Virtual DOM решает эту проблему?

**Virtual DOM** – это виртуальная копия реального DOM, хранящаяся в памяти. По сути, это JavaScript-объект, который описывает структуру UI (дерево элементов), аналогичную реальному DOM. Эта копия содержит те же элементы и свойства, что и настоящая страница, но изменения в ней не приводят сразу к отрисовке на экране. Проще говоря, мы сперва работаем с **DOM «на черновике»**, а не напрямую на странице. Благодаря этому изменения можно вносить сколько угодно часто – это быстрые операции с JS-объектами, никак не нагружающие браузер отрисовкой.

#### Как React использует Virtual DOM для оптимизации

React популяризировал Virtual DOM именно для того, чтобы минимизировать реальные обновления страницы​.

**Работа идет по следующему принципу**: Вместо прямой работы с DOM React делает изменения в Virtual DOM, сравнивает его с реальным DOM, и только потом применяет отличия.

Таким образом, обновляется только то, что реально изменилось, а не всё подряд. Этот процесс называют согласованием (**reconciliation**) – поиском отличий и синхронизацией виртуального и реального DOM. **Манипуляции с Virtual DOM значительно быстрее**, так как ничего не рисуется на экране напрямую. Это похоже на работу с чертежом здания перед строительством: вы вносите изменения в план, сколько нужно, и только когда план готов – перестраиваете только необходимые части здания. Именно так поступает React с интерфейсом – сначала обновляет план (Virtual DOM), а затем минимально изменяет «здание» (реальный DOM) по этому плану.

#### Пошаговый процесс работы Virtual DOM [^3]

1. **Создание виртуального дерева**. При первом рендере React строит виртуальное DOM-дерево, полностью описывающее структуру интерфейса в памяти (VDOM). Каждый элемент интерфейса представлен как узел этого дерева (JS-объект).
2. **Обновление виртуального DOM**. Когда меняется состояние компонента или приходят новые данные, React создает новую виртуальную DOM-структуру (новое дерево объектов) с учётом изменений. _Старое виртуальное дерево при этом сохраняется для сравнения_.
3. **Сравнение (diffing)**. Новое виртуальное дерево сравнивается со старым, чтобы найти, какие узлы (элементы) изменились. React эффективно вычисляет отличия между старым и новым состоянием интерфейса. Узлы, которые не изменились, пропускаются без действий, а для изменённых определяются необходимые обновления.
4. **Обновление реального DOM**. После вычисления отличий React точечно обновляет реальный DOM: вносит только те изменения, которые нужны – добавляет, удаляет или изменяет конкретные узлы DOM, которые поменялись​. Ничего лишнего не перерисовывается. Браузер, в свою очередь, пересчитает стили и перерисует только эти изменённые элементы. Благодаря этому количество операций с настоящим DOM резко сокращается.

> [!TIP]
> React также умеет объединять несколько обновлений в одно (batch-обновление), чтобы не дергать DOM по мелочам на каждое изменение состояния. В итоге интерфейс обновляется быстро и плавно.

_На схеме ниже показан принцип Virtual DOM_. При изменении состояния создаётся новое виртуальное DOM-дерево, затем вычисляются отличия (Compute Diff) и перерисовываются только узлы, которые изменились (они выделены красным). После этого эти изменения обновляются в реальном DOM (нижняя часть схемы), где красным помечены обновлённые элементы браузера. Таким образом, вместо перерисовки всего дерева браузер обновил только изменённые узлы.

![Virtual DOM](https://imgur.com/ue5Lqoy.png) [^2]

### Пример: Virtual DOM в React на счетчике

Рассмотрим React-компонент счётчика с кнопкой **“+1”**. При клике на кнопку число увеличивается на **1**:

```jsx
function Counter() {
  const [count, setCount] = React.useState(0);
  return (
    <div>
      <p>Вы нажали на кнопку {count} раз</p>
      <button onClick={() => setCount(count + 1)}>+1</button>
    </div>
  );
}
```

1. Когда компонент впервые рендерится, Virtual DOM содержит структуру:

   ```
   div
    ├── p
    │   └── Вы нажали на кнопку 0 раз
    └── button
        └── +1
   ```

   Эта структура затем отображается в реальном DOM (на странице).

2. При клике на кнопку:
   1. **Изменение состояния**. При нажатии вызывается `setCount(count + 1)`. Значение `count` меняется с `0` на `1`.
   2. **Обновление Virtual DOM**: React узнаёт, что состояние изменилось, и заново вызывает рендеринг компонента `Counter`. В памяти создаётся новое виртуальное дерево для этого компонента:
      - теперь `<p>` содержит текст `1` (вместо `0`), остальная структура та же (`<div>` и `<button>` без изменений).
   3. **Сравнение с предыдущим состоянием**: React сравнивает новое виртуальное дерево с предыдущей версией. Он обнаруживает, что единственное различие – текст внутри абзаца `<p>` (было `"0"`, стало `"1"`). Кнопка и остальные элементы не изменились.
   4. **Обновление реального DOM**: React применяет только это различие к настоящему DOM: обновляет текст в элементе `<p>` на странице с `"0"` на `"1"`. Ни `<div>`, ни сама кнопка повторно не создаются и не перерисовываются – они остаются прежними. Браузер получит изменение только для текста внутри абзаца и перерасчитает стиль/положение только для этого текста, после чего обновит его на экране.

Важно, что **React не перезагружает всю страницу и даже не заново рисует весь компонент целиком** – изменяется только нужная часть. Это происходит мгновенно и незаметно для пользователя. Если бы мы напрямую манипулировали DOM без Virtual DOM, можно было бы по ошибке обновлять весь блок целиком (например, пересоздать весь `<div>` внутренним HTML), что было бы менее эффективно. Virtual DOM избавляет разработчика от ручного отслеживания изменений – фреймворк сам вычисляет, что поменялось, и аккуратно обновляет только необходимое.

## Recap: Что такое DOM и Virtual DOM

1. **DOM (Document Object Model)**

   - Представляет HTML-документ в виде дерева объектов.
   - JavaScript может изменять DOM (добавлять, удалять, редактировать элементы).
   - Любое изменение вызывает перерасчёт стилей, компоновку (reflow) и перерисовку (repaint), что может замедлять работу страницы.

2. **Проблема с прямыми изменениями DOM**

   - Даже небольшие обновления могут затронуть многие элементы, что снижает производительность.
   - Большие динамические интерфейсы работают медленно при частом обновлении реального DOM.

3. **Что такое Virtual DOM?**

   - Виртуальная копия реального DOM, хранящаяся в памяти.
   - Все изменения в интерфейсе сначала применяются в Virtual DOM, а не в реальном DOM.
   - React вычисляет разницу между старой и новой версией Virtual DOM (diffing) и обновляет только изменённые элементы в реальном DOM.

4. **Как React использует Virtual DOM?**

   - Создаёт виртуальное дерево компонентов.
   - При изменении состояния компонента создаёт новую версию Virtual DOM.
   - Сравнивает новую и старую версию (процесс diffing).
   - Вносит **только необходимые изменения** в реальный DOM.

5. **Преимущества Virtual DOM**

   - Уменьшает количество обновлений реального DOM.
   - Оптимизирует производительность за счёт минимального количества изменений.
   - Позволяет React объединять несколько обновлений (batch-обновления) для более плавного рендера.

6. **Пример работы Virtual DOM**
   - При изменении состояния компонента React обновляет только изменённые элементы, а не всю страницу.
   - Это делает React-приложения более быстрыми и отзывчивыми.

[^1]: _Что такое DOM, Shadow DOM, Virtual DOM?_. alishoff.com [online resource]. Available at: https://alishoff.com/blog/256
[^2]: _Немного о том, как работает виртуальный DOM в React_. habr.com [online resource]. Available at: https://habr.com/ru/companies/macloud/articles/558682/
[^3]: _Что такое Virtual DOM?_. habr.com [online resource]. Available at: https://habr.com/ru/articles/256965/
